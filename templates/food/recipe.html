{% extends 'food/base.html' %}
{% block title %}Recipe Suggestions{% endblock %}

{% block content %}
<div class="container my-5">
    <h2 class="mb-4"><i class="bi bi-chat-dots"></i> AI Recipe Suggestions</h2>
    
    <!-- Expiring Items Alert -->
    <div class="alert alert-warning mb-4">
        <h5>Using these soon-to-expire ingredients:</h5>
        <div class="mt-2">
            {% for item in expiring_items %}
            <span class="badge bg-warning text-dark me-2 mb-2">
                {{ item.grocery_name }} (expires {{ item.ex_date|date:"M d" }})
            </span>
            {% endfor %}
        </div>
    </div>

    <!-- Recipes Container -->
    <div class="recipes-container mb-4">
        <div class="card shadow-lg">
            <div class="card-body">
                <div id="recipes-content" class="recipe-text" style="white-space: pre-wrap; line-height: 1.8;">
                    {{ recipes }}
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="row g-3 mt-4">
        <div class="col-md-6">
            <button class="btn btn-primary w-100" id="refineBtn" data-bs-toggle="modal" data-bs-target="#refineModal">
                <i class="bi bi-sliders"></i> Refine Recipes
            </button>
        </div>
        <div class="col-md-6">
            <button class="btn btn-success w-100" id="saveBtn" data-bs-toggle="modal" data-bs-target="#saveModal">
                <i class="bi bi-bookmark"></i> Save Recipe
            </button>
        </div>
        <div class="col-md-6">
            <a href="{% url 'index' %}" class="btn btn-secondary w-100">
                <i class="bi bi-arrow-left"></i> Back
            </a>
        </div>
        <div class="col-md-6">
            <button class="btn btn-outline-primary w-100" id="regenerateBtn">
                <i class="bi bi-arrow-clockwise"></i> Regenerate
            </button>
        </div>
    </div>
</div>

<!-- Refine Recipe Modal -->
<div class="modal fade" id="refineModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Refine Recipes</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-3">Add preferences to modify the recipes:</p>
                <div class="mb-3">
                    <label class="form-label">Preferences (comma-separated)</label>
                    <input type="text" class="form-control" id="preferencesInput" 
                           placeholder="e.g., vegetarian, quick, spicy, healthy, budget-friendly">
                    <small class="text-muted">Examples: vegan, gluten-free, low-carb, high-protein</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="refineSubmitBtn">Refine</button>
            </div>
        </div>
    </div>
</div>

<!-- Save Recipe Modal -->
<div class="modal fade" id="saveModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Save Recipe</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Recipe Name</label>
                    <input type="text" class="form-control" id="recipeName" placeholder="Enter recipe name">
                </div>
                <div class="mb-3">
                    <label class="form-label">Select which recipe to save (paste the name)</label>
                    <textarea class="form-control" id="recipeContent" rows="4" placeholder="The recipe will be saved to your collection"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="saveSubmitBtn">Save Recipe</button>
            </div>
        </div>
    </div>
</div>

<script>
    const refineSubmitBtn = document.getElementById('refineSubmitBtn');
    const saveSubmitBtn = document.getElementById('saveSubmitBtn');
    const preferencesInput = document.getElementById('preferencesInput');
    const recipeName = document.getElementById('recipeName');
    const recipeContent = document.getElementById('recipeContent');

    // Refine recipes
    refineSubmitBtn.addEventListener('click', async () => {
        const preferences = preferencesInput.value.trim();
        if (!preferences) {
            alert('Please enter preferences');
            return;
        }

        refineSubmitBtn.disabled = true;
        refineSubmitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Refining...';

        try {
            const response = await fetch('{% url "refine_recipe" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    recipe: document.getElementById('recipes-content').innerText,
                    preferences: preferences
                })
            });

            const data = await response.json();
            if (data.status === 'success') {
                document.getElementById('recipes-content').innerText = data.recipe;
                bootstrap.Modal.getInstance(document.getElementById('refineModal')).hide();
                alert('Recipes refined successfully!');
            } else {
                alert('Error: ' + data.message);
            }
        } catch (error) {
            alert('Error: ' + error);
        } finally {
            refineSubmitBtn.disabled = false;
            refineSubmitBtn.innerHTML = 'Refine';
        }
    });

    // Save recipe
    saveSubmitBtn.addEventListener('click', async () => {
        if (!recipeName.value.trim() || !recipeContent.value.trim()) {
            alert('Please fill in all fields');
            return;
        }

        saveSubmitBtn.disabled = true;
        saveSubmitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';

        try {
            const response = await fetch('{% url "save_recipe" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    recipe_name: recipeName.value,
                    instructions: recipeContent.value,
                    ingredients: {}
                })
            });

            const data = await response.json();
            if (data.status === 'success') {
                bootstrap.Modal.getInstance(document.getElementById('saveModal')).hide();
                alert(data.message);
                recipeName.value = '';
                recipeContent.value = '';
            } else {
                alert('Error: ' + data.message);
            }
        } catch (error) {
            alert('Error: ' + error);
        } finally {
            saveSubmitBtn.disabled = false;
            saveSubmitBtn.innerHTML = 'Save Recipe';
        }
    });

    // Regenerate recipes
    document.getElementById('regenerateBtn').addEventListener('click', () => {
        location.reload();
    });
</script>
{% endblock %}